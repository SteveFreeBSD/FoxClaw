# WS-79 Evidence (2026-02-27)

## Scope

Make local session-memory indexing and querying reliable on a fresh checkout, prevent `checkpoints_fts` crashes from blocking forensic review, and expose memory-index health in soak summaries.

## Reproduction Snippet (Pre-Fix Failure)

Deterministic stale-schema repro before the fix:

```bash
python scripts/session_memory.py checkpoint --focus "fts regression" --next "verify"
python scripts/memory_index.py build
sqlite3 artifacts/session_memory/index.sqlite 'DROP TABLE checkpoints_fts;'
python scripts/memory_query.py 'fts'
```

Observed failure:

```text
Traceback (most recent call last):
  ...
sqlite3.OperationalError: no such table: checkpoints_fts
```

## Fix Verification

Post-fix stale-schema behavior with the same `DROP TABLE checkpoints_fts` setup:

```text
[memory-query] warning: checkpoints_fts unavailable; using LIKE fallback
[memory-query] top 1 hits for: "fts regression"
1. 2026-02-27T18:00:00+00:00  commit=deadbeefcafebabe
   focus: fts regression
   next:  verify query output
```

Targeted regressions:

```bash
.venv/bin/pytest -q tests/test_memory_index_query.py tests/test_soak_summary.py
```

Result:

```text
6 passed in 0.57s
```

Lint on touched files:

```bash
.venv/bin/ruff check scripts/memory_index.py scripts/memory_query.py scripts/soak_summary.py tests/test_memory_index_query.py tests/test_soak_summary.py
```

Result:

```text
All checks passed!
```

Full suite:

```bash
.venv/bin/pytest -q
```

Result:

```text
286 passed, 7 skipped in 24.42s
```

## Manual Smoke

Rebuild the default local index:

```bash
python scripts/memory_index.py build
```

Output:

```text
[memory-index] built artifacts/session_memory/index.sqlite from artifacts/session_memory/SESSION_MEMORY.jsonl (31 checkpoints)
```

Query the rebuilt index:

```bash
python scripts/memory_query.py '"checkpoints_fts"' --limit 2
```

Output:

```text
[memory-query] top 2 hits for: "checkpoints_fts"
1. 2026-02-27T16:13:29.899291+00:00  commit=9da65349a6060122fda272835dc4fbf3f2b4a82a
   focus: WS-75: add native Wazuh production-hardening lane
   next:  Hold Rust bootstrap until Python production/SIEM evidence is explicitly accepted
2. 2026-02-27T16:53:20.473742+00:00  commit=46be00b85e470a83d8a105b8172d1bdb9884ff10
   focus: WS-78: harden soak gate and Wazuh lane reliability
   next:  Hold Rust bootstrap until Python production/SIEM soak evidence is explicitly accepted
```

## Delivered Behavior

- `memory_index.py build` is repeatable, supports explicit index/source paths, and builds an empty local index cleanly when no journal exists yet.
- `memory_query.py` accepts `--index-path`, supports `--repair`, falls back to `LIKE` when `checkpoints_fts` is absent, and prints concise remediation guidance instead of tracebacks.
- `soak-summary.json` now includes `memory_index_status`, `memory_index_path`, and `last_checkpoint_id` when the local memory index can be inspected cheaply.
