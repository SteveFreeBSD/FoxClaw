# FoxClaw Comprehensive Audit — 2026-02-24

> **Status:** Pre-CTO-merge review
> **Scope:** Full codebase (55+ source files), 34 docs, 35 test modules, CI/quality gates
> **Linter (configured rules):** `ruff check .` — E, F, I, UP, B, RUF

---

## Executive Summary

The FoxClaw codebase is well-engineered, security-conscious, and thoroughly tested. It passes `pytest` (179 tests), `mypy`, `bandit`, and `vulture` cleanly. Two quality gates (`ruff`, `detect-secrets`) currently fail on minor issues. This report documents **1 critical**, **2 high**, **6 medium**, and **2 low** findings, plus structural redundancy observations and open design questions requiring team decision.

---

## Quality & Security Gate Results

| Gate | Status | Notes |
|------|--------|-------|
| `pytest -q tests/` | ✅ 179 passed (6.23s) | All unit + integration tests green |
| `mypy foxclaw` | ✅ No issues | Strict mode configured |
| `bandit -q -r foxclaw -x tests` | ✅ No findings | `nosec` annotations appropriate |
| `vulture foxclaw tests --min-confidence 80` | ✅ No findings | No dead code detected |
| `ruff check .` (configured rules) | ❌ 1 error | Import order in `test_scan_history.py:3` |
| `detect-secrets scan` | ❌ 2 files | `mutate_profile.mjs:618,620`; `test_credentials.py:66,72` |

---

## Findings by Severity

### CRITICAL

#### C-1: Operational input error returns exit code 2 (reserved for findings)

| | |
|---|---|
| **File** | [windows_share.py:392-394](file:///home/steve/apps/FoxClaw/foxclaw/acquire/windows_share.py#L392-L394) |
| **Impact** | CI/pipelines misclassify config failures as "scan completed with HIGH findings" |

`--intel-snapshot-id` without `--intel-store-dir` returns exit code `2`. Per the documented contract ([README.md](file:///home/steve/apps/FoxClaw/README.md), [ARCHITECTURE.md](file:///home/steve/apps/FoxClaw/docs/ARCHITECTURE.md)), exit `1` = operational error, exit `2` = HIGH findings present.

```python
if args.intel_snapshot_id and not args.intel_store_dir:
    print("error: --intel-snapshot-id requires --intel-store-dir", file=err_stream)
    return 2  # BUG: should be 1
```

> **Fix:** Change `return 2` → `return 1`.

---

### HIGH

#### H-1: UNC fail-closed guard enforced in `scan` but missing from `live`

| | |
|---|---|
| **File (guard present)** | [cli.py:202-208](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L202-L208) |
| **File (guard absent)** | [cli.py:447-465](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L447-L465) |
| **Architecture invariant** | [ARCHITECTURE.md](file:///home/steve/apps/FoxClaw/docs/ARCHITECTURE.md) — "UNC direct scanning disabled by default" |
| **Impact** | Command-surface inconsistency; potential direct UNC scan path via `live` |

The `scan` command checks `_is_unc_path(profile)` and rejects it unless `--allow-unc-profile` is passed. The `live` command calls `_build_profile_override(profile)` without performing this check.

> **Fix:** Add the same UNC guard block before `_build_profile_override(profile)` in the `live` command.

---

#### H-2: `detect-secrets` gate currently fails

| | |
|---|---|
| **Files flagged** | `mutate_profile.mjs:618,620`; `test_credentials.py:66,72` |
| **Exclude config** | [check_secrets.sh:12](file:///home/steve/apps/FoxClaw/scripts/check_secrets.sh#L12) |
| **Impact** | GitHub quality-gates remain red on secret scan |

The current exclude patterns in `check_secrets.sh` do not cover these files.

> **Fix:** Add exclusion patterns for the known false positives, or add inline `# pragma: allowlist secret` comments.

---

### MEDIUM

#### M-1: Lint gate currently fails

| | |
|---|---|
| **File** | `tests/test_scan_history.py:3` |
| **Rule** | Import order (I-series) |
| **Impact** | Quality gate red even though runtime tests pass |

> **Fix:** `ruff check --fix tests/test_scan_history.py`

---

#### M-2: Active-profile lock marker handling inconsistent

The lock marker tuple differs across the codebase:

| Location | Tuple |
|---|---|
| [windows_share.py:20](file:///home/steve/apps/FoxClaw/foxclaw/acquire/windows_share.py#L20) | `("parent.lock", ".parentlock", "lock")` |
| [profiles.py:12](file:///home/steve/apps/FoxClaw/foxclaw/profiles.py#L12) | `("parent.lock", "lock")` |
| [scan.py:34](file:///home/steve/apps/FoxClaw/foxclaw/scan.py#L34) | `("parent.lock", "lock")` |

`.parentlock` may be missed during normal scan/profile-selection and quiet-profile checks.

> **Fix:** Consolidate into a single canonical constant and decide whether `.parentlock` should be checked everywhere.

---

#### M-3: Learning artifact claims determinism but includes wall-clock timestamp

| | |
|---|---|
| **Code** | [history.py:257-260](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py#L257-L260) (docstring says "deterministic") |
| **Timestamp** | [history.py:310](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py#L310) (`datetime.now(UTC)`) |
| **Doc claim** | [SCAN_LEARNING_LOOP.md](file:///home/steve/apps/FoxClaw/docs/SCAN_LEARNING_LOOP.md) |
| **Impact** | Artifact differs across runs with identical DB content |

> **Fix:** Either accept the timestamp as metadata (update docstring/docs) or make it an optional injection parameter.

---

#### M-4: `hasattr()` dead code in `learning/history.py`

Three `hasattr()` calls check for attributes that don't exist on `EvidenceBundle`:

| Line | Check | Effect |
|---|---|---|
| [79](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py#L79) | `hasattr(evidence, 'firefox_version')` | Always `False` → `firefox_version` is always `None` |
| [93](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py#L93) | `hasattr(evidence, 'artifacts')` | Field exists on `EvidenceBundle`; guard is redundant |
| [103](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py#L103) | `hasattr(evidence, 'ruleset_name')` | Always `False` → always returns `(None, None)` |

> **Impact:** History records never capture Firefox version or ruleset metadata.
> **Fix:** Either add these fields to `EvidenceBundle` or use the existing extraction approach (`_extract_firefox_version` via `compatibility.ini` artifact).

---

#### M-5: Documentation drift and correctness issues

| Issue | Details |
|---|---|
| WS-55A marked pending | Implemented in code ([history.py](file:///home/steve/apps/FoxClaw/foxclaw/learning/history.py), [cli.py:182](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L182)) but docs still say in-progress: [PREMERGE_READINESS.md:66](file:///home/steve/apps/FoxClaw/docs/PREMERGE_READINESS.md), [WORKSLICES.md:81](file:///home/steve/apps/FoxClaw/docs/WORKSLICES.md), [SCAN_LEARNING_LOOP.md:20](file:///home/steve/apps/FoxClaw/docs/SCAN_LEARNING_LOOP.md) |
| Malformed table | [WORKSLICES.md:81](file:///home/steve/apps/FoxClaw/docs/WORKSLICES.md) contains `|\n|` embedded in table text |
| HSTS artifact name mismatch | Code uses `SiteSecurityServiceState.bin` ([artifacts.py:17](file:///home/steve/apps/FoxClaw/foxclaw/collect/artifacts.py#L17)); docs reference `.txt` ([SECURITY_MODEL.md:78](file:///home/steve/apps/FoxClaw/docs/SECURITY_MODEL.md), [WORKSLICES.md:79](file:///home/steve/apps/FoxClaw/docs/WORKSLICES.md)) |
| Exit code 2 contract too narrow | README says exit `2` = "HIGH findings". But `2` is also returned for snapshot drift ([cli.py:974](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L974)) and suppression audit violations ([cli.py:1123,1140](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L1123)) |

---

#### M-6: Code duplication across modules

Six copies of `_SEVERITY_ORDER`:

| File | Line |
|---|---|
| [engine.py](file:///home/steve/apps/FoxClaw/foxclaw/rules/engine.py#L16) | 16 |
| [correlation.py](file:///home/steve/apps/FoxClaw/foxclaw/intel/correlation.py#L18) | 18 |
| [sarif.py](file:///home/steve/apps/FoxClaw/foxclaw/report/sarif.py#L18) | 18 |
| [snapshot.py](file:///home/steve/apps/FoxClaw/foxclaw/report/snapshot.py#L15) | 15 |
| [snapshot_diff.py](file:///home/steve/apps/FoxClaw/foxclaw/report/snapshot_diff.py#L20) | 20 |
| [fleet.py](file:///home/steve/apps/FoxClaw/foxclaw/report/fleet.py#L21) | 21 |

Three copies of `_table_exists()`:

| File | Line |
|---|---|
| [blocklist.py](file:///home/steve/apps/FoxClaw/foxclaw/intel/blocklist.py#L61) | 61 |
| [correlation.py](file:///home/steve/apps/FoxClaw/foxclaw/intel/correlation.py#L443) | 443 |
| [reputation.py](file:///home/steve/apps/FoxClaw/foxclaw/intel/reputation.py#L133) | 133 |

Two copies of `_sqlite_ro_uri()`:

| File | Line |
|---|---|
| [credentials.py](file:///home/steve/apps/FoxClaw/foxclaw/collect/credentials.py#L146) | 146 |
| [sqlite.py](file:///home/steve/apps/FoxClaw/foxclaw/collect/sqlite.py#L71) | 71 |

> **Recommendation:** Consolidate `_SEVERITY_ORDER` into `models.py`, `_table_exists` into a shared intel helper, and `_sqlite_ro_uri` into `collect/safe_paths.py`.

---

### LOW

#### L-1: Public flag spelling typo locked into CLI/docs

`--keep-stage-writeable` (British spelling of writable) used in:
- [windows_share.py:119](file:///home/steve/apps/FoxClaw/foxclaw/acquire/windows_share.py#L119)
- [cli.py:609](file:///home/steve/apps/FoxClaw/foxclaw/cli.py#L609)
- [WINDOWS_SHARE_TESTING.md:119](file:///home/steve/apps/FoxClaw/docs/WINDOWS_SHARE_TESTING.md)

> **Impact:** Avoidable public API spelling inconsistency; causes long-term compatibility debt.

---

#### L-2: Policy-path symlink rejection message misleading

[policies.py:92-93](file:///home/steve/apps/FoxClaw/foxclaw/collect/policies.py#L92-L93) raises `ProfilePathSymlinkError` with "profile path" wording when validating `--policy-path` inputs.

> **Impact:** Confusing operator-facing diagnostics when symlinks are used in policy paths.

---

#### L-3: Private API cross-module imports in `rules/`

[keyring.py:12-17](file:///home/steve/apps/FoxClaw/foxclaw/rules/keyring.py#L12-L17) imports private functions from `trust.py`:

```python
from foxclaw.rules.trust import (
    _validate_key_availability,   # private
    _verify_ed25519_signature,    # private
)
```

> **Recommendation:** Promote to public API (remove underscore prefix) since they are genuinely part of the rules package's interface.

---

## Security Posture — No Issues Found

| Area | Implementation |
|---|---|
| Path traversal | `safe_paths.py` guards all profile access with `resolve()` + containment check |
| Symlink defense | Explicit rejection in `safe_paths.py`, `windows_share.py`, `bundle.py` |
| SQLite read-only | URI mode `?mode=ro` in `credentials.py` and `sqlite.py` |
| Tar extraction | `_safe_extract_tar()` validates all members against install root, rejects links |
| Signature verification | Ed25519 via `cryptography`, key availability windows enforced |
| HTTP transport | Insecure HTTP blocked by default; requires `--allow-insecure-http` |
| UNC restrictions | Blocked on non-Windows (in `scan`; *see H-1 for `live` gap*) |
| Staging root | Cannot be `/`, `$HOME`, or overlap with source profile |
| Suppression governance | Schema 1.1.0 requires approval chain with chronological validation |
| SQL injection | All queries use parameterized `?` placeholders |
| Code injection | No `eval()`, `exec()`, `pickle`, or shell injection vectors |
| Secrets | No hardcoded secrets or tokens in production code |

---

## Dead Code & Empty Functions

- **No empty function bodies** found across `foxclaw/` (`pass`, `...`, `NotImplementedError` scan all negative)
- **No high-confidence dead code** flagged by `vulture` for `foxclaw/` + `tests/`
- **Structural redundancy risk** exists between `scan` and `live` orchestration in `cli.py` (already causing the H-1 guard drift)

---

## Architecture Strengths

| Dimension | Evidence |
|---|---|
| **Modularity** | Clean subpackage separation: `collect/`, `intel/`, `rules/`, `report/`, `acquire/`, `release/`, `learning/` |
| **Type safety** | Comprehensive type hints + Pydantic `BaseModel` throughout |
| **Determinism** | Sorted outputs, deterministic hashes, snapshot IDs, reproducible SARIF fingerprints |
| **Test coverage** | 35 test modules covering unit, integration, adversary profiles, scripts |
| **Documentation** | 34 docs covering architecture, security model, SARIF, suppressions, research, soak testing |

---

## Open Questions for CTO Decision

These design questions require team consensus before merge:

1. **Exit code 2 scope:** Should exit code `2` be strictly "HIGH findings only" across all commands, or is it acceptable for snapshot-drift and suppression-audit violations to also use `2`?

2. **`live` UNC policy:** Should `live` explicitly inherit the same UNC fail-closed policy as `scan`?

3. **Learning artifact determinism:** Should the learning artifact be byte-for-byte deterministic (no generation timestamp), or is deterministic-except-metadata-timestamp acceptable?

4. **Lock marker consolidation:** Should `.parentlock` be added to all lock-marker checks, or kept only in the acquire path?

5. **`--keep-stage-writeable` spelling:** Accept the British spelling as-is, add an alias `--keep-stage-writable`, or rename (breaking change)?

---

## Recommended Fix Priority

| # | Sev | Fix | Effort |
|---|---|---|---|
| C-1 | Critical | Change exit code `2` → `1` in `windows_share.py:394` | 1 line |
| H-1 | High | Add UNC guard in `live` command | ~5 lines |
| H-2 | High | Update `check_secrets.sh` exclude patterns | ~2 lines |
| M-1 | Medium | `ruff --fix tests/test_scan_history.py` | Auto-fix |
| M-2 | Medium | Consolidate lock marker constant | ~15 min |
| M-3 | Medium | Clarify determinism claim in `history.py` | ~10 min |
| M-4 | Medium | Fix `hasattr()` dead code in `history.py` | ~30 min |
| M-5 | Medium | Update docs (WS-55A status, HSTS name, exit code contract) | ~30 min |
| M-6 | Medium | Consolidate duplicated constants/helpers | Fixed (WS-62) |
| L-1 | Low | Decide on `--keep-stage-writeable` spelling | Team decision |
| L-2 | Low | Fix misleading symlink error message in `policies.py` | ~5 min |
| L-3 | Low | Promote private trust functions to public API | ~10 min |
