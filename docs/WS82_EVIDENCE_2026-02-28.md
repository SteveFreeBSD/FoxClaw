# WS-82 Evidence (2026-02-28)

WS-82 proves that FoxClaw's native ECS output is not just syntactically ECS, but operationally acceptable to a real Elastic Security stack.

## 1. Scope

This slice validates three things against a pinned local Elastic stack:

- FoxClaw ECS events ingest cleanly into an Elastic `logs-*` data stream without custom remapping.
- Elastic Security's required ECS fields are present and searchable.
- The detection engine can preview a rule over the ingested FoxClaw events without field errors.

Pinned stack used for the proof:

- Elasticsearch: `docker.elastic.co/elasticsearch/elasticsearch:9.3.1`
- Kibana: `docker.elastic.co/kibana/kibana:9.3.1`

Primary Elastic references used for acceptance criteria:

- ECS reference: <https://www.elastic.co/docs/reference/ecs>
- Elastic Security field reference: <https://www.elastic.co/guide/en/security/current/siem-field-reference.html/>
- Elastic Security requirements: <https://www.elastic.co/docs/solutions/security/get-started/elastic-security-requirements>
- Elastic Docker install guidance: <https://www.elastic.co/guide/en/elasticsearch/reference/current/docker.html>
- Elastic data stream naming scheme: <https://www.elastic.co/docs/reference/fleet/data-streams>
- Elastic detections requirements: <https://www.elastic.co/guide/en/security/current/detections-permissions-section.html>

## 2. Real Live Smoke

Command used:

```bash
run_id="$(date -u +%Y%m%dT%H%M%SZ)"
output_dir="/var/tmp/foxclaw-elastic-smoke-${run_id}"
.venv/bin/python scripts/siem_elastic_smoke.py --output-dir "${output_dir}"
```

Passing run on this host:

- output dir: `/var/tmp/foxclaw-elastic-smoke-20260228T175813Z`
- manifest: `/var/tmp/foxclaw-elastic-smoke-20260228T175813Z/manifest.json`

Observed manifest excerpt:

```json
{
  "status": "PASS",
  "exit_code": 0,
  "elasticsearch_image": "docker.elastic.co/elasticsearch/elasticsearch:9.3.1",
  "kibana_image": "docker.elastic.co/kibana/kibana:9.3.1",
  "index_name": "logs-foxclaw.scan-default",
  "search_hits": 5,
  "kibana_status": "available",
  "generated_at_utc": "2026-02-28T17:58:13Z",
  "required_fields_present": [
    "@timestamp",
    "ecs.version",
    "event.category",
    "event.kind",
    "event.type",
    "host.id",
    "host.name"
  ]
}
```

Observed rule preview excerpt:

```json
{
  "isAborted": false,
  "logs": [
    {
      "duration": 228,
      "errors": [],
      "startedAt": "2026-02-28T17:59:14.000Z",
      "warnings": []
    }
  ]
}
```

Observed field-caps excerpt:

```json
{
  "fields": {
    "@timestamp": { "date": { "searchable": true, "aggregatable": true } },
    "ecs.version": { "keyword": { "searchable": true, "aggregatable": true } },
    "event.category": { "keyword": { "searchable": true, "aggregatable": true } },
    "event.kind": { "keyword": { "searchable": true, "aggregatable": true } },
    "event.type": { "keyword": { "searchable": true, "aggregatable": true } },
    "host.id": { "keyword": { "searchable": true, "aggregatable": true } },
    "host.name": { "keyword": { "searchable": true, "aggregatable": true } }
  },
  "indices": [
    ".ds-logs-foxclaw.scan-default-2026.02.28-000001"
  ]
}
```

## 3. Integration Failures Surfaced And Fixed

The live proof surfaced real Elastic integration gaps that deterministic unit tests alone would not have caught:

1. Transient Elasticsearch readiness resets could escape as a Python traceback.
   - Fixed by treating socket-level connection resets as retryable operational failures.
2. `logs-*` ingest triggered Elastic data-stream behavior, but FoxClaw ECS events lacked `data_stream.*`.
   - Fixed by adding:
     - `data_stream.type = "logs"`
     - `data_stream.dataset = "foxclaw.scan"`
     - `data_stream.namespace = "default"`
3. Elasticsearch data streams reject bulk `index` actions.
   - Fixed by using bulk `create` actions.
4. Kibana rule preview required explicit `invocationCount` and `timeframeEnd`.
   - Fixed by adding those fields to the preview request body.

Result: the current smoke runner now exercises the same path that previously failed and passes end to end.

## 4. Kibana / Security UI Check

To keep the stack alive for manual inspection:

```bash
run_id="$(date -u +%Y%m%dT%H%M%SZ)"
output_dir="/var/tmp/foxclaw-elastic-smoke-${run_id}"
.venv/bin/python scripts/siem_elastic_smoke.py \
  --output-dir "${output_dir}" \
  --keep-containers
```

Then open:

```text
http://127.0.0.1:5601/app/security
```

Local smoke credentials:

- username: `elastic`
- password: `foxclawelastic1` <!-- pragma: allowlist secret -->

Useful checks in the UI:

1. Open `Discover` and query:

```text
event.action : "foxclaw.finding" or event.action : "foxclaw.scan.summary"
```

2. Confirm documents are in:

```text
logs-foxclaw.scan-default
```

3. Confirm the event detail flyout shows:

- `data_stream.dataset = foxclaw.scan`
- `ecs.version`
- `event.kind`
- `event.category`
- `event.type`
- `host.name`
- `host.id`
- `foxclaw.event_type`

4. In the Security app, use the ingested events for host-centric pivots and verify the documents render as ECS-backed events without field errors.

Important caveat:

- FoxClaw emits host/configuration assessment events, not endpoint process/network telemetry. Host pivots and generic ECS-backed timelines are meaningful acceptance checks; many unrelated prebuilt endpoint detections are not.

## 5. Deterministic Regression Coverage

Focused verification:

```bash
ruff check foxclaw/report/ecs.py scripts/siem_elastic_smoke.py tests/test_ecs.py tests/test_siem_elastic_smoke_script.py
.venv/bin/vulture foxclaw scripts tests/test_ecs.py tests/test_siem_elastic_smoke_script.py --min-confidence 80
.venv/bin/pytest -q tests/test_ecs.py tests/test_siem_elastic_smoke_script.py
.venv/bin/pytest -q
```

Observed result:

- `ruff check`: passed
- `.venv/bin/vulture`: passed
- focused pytest: `14 passed in 12.72s`
- full pytest: `304 passed, 7 skipped in 33.64s`

Covered cases:

- ECS renderer now includes `data_stream.*`
- Elastic smoke happy path
- missing pinned image failure
- readiness retry loops
- transient connection resets during Elasticsearch startup
- missing required Security fields
- rule-preview API error handling

## 6. Result

WS-82 acceptance points are satisfied:

- FoxClaw ECS output lands in a real Elastic `logs-*` data stream without remapping.
- Elastic Security's required ECS fields are present and searchable.
- Kibana Security rule preview executes without field errors on the ingested FoxClaw events.
- The live proving path exposed and closed real integration failures before Rust handoff.
