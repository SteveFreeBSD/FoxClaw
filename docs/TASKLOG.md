# Task Log

## 2026-02-19
- Initialized project memory/process files (`agents/AGENTS.md` and docs baseline set).
- Completed research pass with 16 linked sources across Mozilla, SQLite, SARIF, and adjacent security tooling.
- Updated ADRs with selection strategy, trust-boundary enforcement, and deterministic output decisions.
- Implemented M1 profile discovery and `foxclaw profiles list`:
  - deterministic search path resolution (`XDG_CONFIG_HOME`, `~/.config`, `~/.mozilla`)
  - robust `profiles.ini` parsing
  - lock-file precedence (`parent.lock` / `lock`)
  - deterministic score components (`.default-release`, `Default=1`, `places.sqlite` size, dir mtime)
  - explicit selection reason metadata and CLI display
  - tests for lock precedence, suffix scoring, search-order precedence, and CLI output
- Verification: `.venv/bin/pytest -q` => 6 passed.
- Implemented M2 `foxclaw scan` with read-only collectors and structured output:
  - Pydantic evidence models (`EvidenceBundle`, prefs/perms/policies/sqlite models, summary counters)
  - prefs collector for `prefs.js` + `user.js` (bool/int/string, user.js precedence, no default invention)
  - filesystem permission collector for sensitive files + sqlite wal/shm sidecars
  - policies collector for Linux system policy paths with top-level key summaries
  - sqlite collector running read-only `PRAGMA quick_check` on `places.sqlite` and `cookies.sqlite`
  - CLI scan summary (Rich), `--json`, and `--output` JSON file writing
  - exit code contract: `0` no HIGH, `2` HIGH findings, `1` operational errors
  - added `python -m foxclaw` entrypoint via `foxclaw/__main__.py`
  - tests for prefs parser, permission flags, sqlite quick_check, and scan JSON schema sections
- Verification commands:
  - `python -m venv .venv`
  - `.venv/bin/pip install -e '.[dev]'`
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --json`
- Verification result: `.venv/bin/pytest -q` => 10 passed.
- M2 follow-up hardening:
  - treat unreadable selected profile directories as operational errors (exit code `1`)
  - Rich scan summary now reports SQLite checks as `total/non-ok` explicitly
- Follow-up verification:
  - `.venv/bin/pytest -q` => 10 passed.
  - `.venv/bin/python -m foxclaw scan --json` => exit `2` on current host due HIGH findings; JSON emitted successfully.
- Implemented M3 rules engine and findings evaluation from M2 evidence:
  - added finding model (`id`, `title`, `severity`, `category`, `rationale`, `recommendation`, `confidence`, `evidence`)
  - deterministic finding ordering by severity (`HIGH` -> `MEDIUM` -> `INFO`) then rule `id`
  - implemented YAML ruleset loading/validation for `foxclaw/rulesets/balanced.yml` with metadata:
    - `name`, `version`, optional `min_firefox_major`
  - implemented DSL checks:
    - `pref_equals`
    - `pref_exists`
    - `file_perm_strict` (supports `path_glob` and well-known file key)
    - `policy_key_exists` (dotted path matching against collected policy key paths)
    - `sqlite_quickcheck_ok` (`places`/`cookies`)
  - wired scan orchestration to evaluate rules and attach `findings` to JSON output
  - added findings summary fields to scan summary (`findings_total`, per-severity counts)
  - updated Rich scan output with findings counts by severity and top 5 HIGH rule IDs
  - added tests:
    - DSL unit coverage for all 5 checks
    - end-to-end CLI scan test with temp profile + temp ruleset producing HIGH and INFO findings
- M3 verification commands:
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --json`
- M3 verification result:
  - `.venv/bin/pytest -q` => 16 passed.
  - `.venv/bin/python -m foxclaw scan --json` => exit `2` on current host; JSON includes `findings`.
- Implemented M4 SARIF 2.1.0 reporting:
  - completed `foxclaw/report/sarif.py` SARIF generation from findings
  - SARIF payload includes:
    - top-level `$schema` and `version` (`2.1.0`)
    - `runs[0].tool.driver.name = "FoxClaw"`
    - `rules` derived from unique finding IDs, sorted by rule ID
    - `results` with severity mapping (`HIGH=error`, `MEDIUM=warning`, `INFO=note`)
    - per-result `ruleId`, `message.text`, and location artifact URI
      - evidence path if present
      - fallback URI `foxclaw://profile` otherwise
  - wired scan CLI options:
    - `--sarif` prints SARIF to stdout
    - `--sarif-out <path>` writes SARIF to file
    - `--json` + `--sarif` now fails with operational error (exit `1`)
  - maintained deterministic/stable SARIF output (no timestamps)
  - added tests for SARIF required fields, severity mapping, results/rules consistency, and CLI option handling
- M4 verification commands:
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --sarif`
  - `.venv/bin/python -m foxclaw scan --sarif-out /tmp/foxclaw-scan.sarif`
  - `.venv/bin/python -m foxclaw scan --json --sarif`
- M4 verification result:
  - `.venv/bin/pytest -q` => 20 passed.
  - `scan --sarif` => valid SARIF emitted; exit `2` on current host due HIGH findings.
  - `scan --sarif-out ...` => SARIF file written; exit `2` on current host due HIGH findings.
  - `scan --json --sarif` => operational error with exit `1` (mutual exclusivity enforced).
- Implemented CI security workflow (GitHub Actions) with production-oriented signal:
  - added `.github/workflows/foxclaw-security.yml` multi-job pipeline:
    - `test` matrix on Python `3.12/3.13/3.14`
    - `scan-balanced` with deterministic fixture and SARIF/JSON artifacts
    - `scan-strict` with strict baseline policy gate (fails on HIGH findings)
    - `sarif-upload` using official `github/codeql-action/upload-sarif`
    - `snapshot-artifact` signed snapshot bundle upload
  - added `foxclaw/rulesets/strict.yml` for strict baseline execution
  - added `foxclaw scan --ruleset <path>` option for explicit ruleset selection in CI
  - added workflow architecture doc: `docs/GITHUB_ACTIONS.md`
  - added README badge snippet block
- CI workflow verification commands:
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --ruleset foxclaw/rulesets/balanced.yml --json`
  - `.venv/bin/python -m foxclaw scan --ruleset foxclaw/rulesets/strict.yml --json`
- CI workflow verification result:
  - `.venv/bin/pytest -q` => 20 passed.
  - balanced scan command works with explicit ruleset selection.
  - strict scan command returns HIGH findings (non-zero by policy on current host).
- Implemented M3.1 hardening pass (audit-only trust-boundary improvements):
  - added `scan --profile <path>` to scan a specific profile directory directly (discovery bypass)
  - added `scan --require-quiet-profile` guard:
    - treats selected profile as active when `parent.lock`/`lock` is present
    - also treats profile as active when a running Firefox process is detected
    - exits with operational code `1` and clear message before scan execution
    - ensures sqlite checks are not started when quiet profile is required and active
  - hardened sqlite collector:
    - read-only URI with `mode=ro&immutable=1`
    - `PRAGMA busy_timeout=250`
    - `PRAGMA query_only=ON`
    - `PRAGMA temp_store=MEMORY`
    - executes only `PRAGMA quick_check` for integrity check
  - aligned output consistency:
    - `high_findings` is now list of HIGH finding IDs
    - summary counts align with findings array (`findings_total`, per-severity counts, `high_findings_count`)
    - detailed evidence remains in each `Finding.evidence`
  - added tests:
    - `--profile` override behavior
    - `--require-quiet-profile` lock-file behavior (and sqlite collector non-execution)
    - `high_findings` ID semantics + summary/count alignment
- M3.1 verification commands:
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --profile /home/steve/.config/mozilla/firefox/gkb5r40r.default-release --json`
  - `.venv/bin/python -m foxclaw scan --profile /home/steve/.config/mozilla/firefox/gkb5r40r.default-release --require-quiet-profile --json`
- M3.1 verification result:
  - `.venv/bin/pytest -q` => 23 passed.
  - profile override command works and emits JSON.
  - quiet-profile guard exits `1` when profile appears active, before scan checks run.
- M4 (security wow integration) workflow refresh without scan-logic changes:
  - added synthetic scan fixture profile at `tests/fixtures/firefox_profile/`:
    - `prefs.js` with non-sensitive synthetic preference
    - `places.sqlite` / `cookies.sqlite` minimal valid SQLite DBs (no browsing data)
    - `key4.db` placeholder synthetic file
  - replaced workflow with a focused GitHub Actions security pipeline:
    - `test` matrix: Python `3.12`, `3.13`, `3.14`
    - `scan-balanced`: runs `foxclaw scan --profile tests/fixtures/firefox_profile --output foxclaw.json --sarif-out foxclaw.sarif`
    - `upload-sarif`: uploads SARIF via official `github/codeql-action/upload-sarif`
  - added branch-scoped concurrency with cancel-in-progress
  - scan-balanced step now treats exit `2` (findings) as expected signal and keeps pipeline green; only unexpected non-zero exits fail
  - refreshed `README.md` badges and added a short GitHub security integration section
  - refreshed `docs/GITHUB_ACTIONS.md` to document workflow architecture and SARIF upload path
- M4 verification commands:
  - `.venv/bin/pytest -q`
  - `.venv/bin/python -m foxclaw scan --profile tests/fixtures/firefox_profile --ruleset foxclaw/rulesets/balanced.yml --output /tmp/foxclaw-fixture.json --sarif-out /tmp/foxclaw-fixture.sarif`
  - `.venv/bin/python -c "import json; json.load(open('/tmp/foxclaw-fixture.json')); json.load(open('/tmp/foxclaw-fixture.sarif')); print('fixture outputs ok')"`
  - `.venv/bin/python -c \"import yaml, pathlib; yaml.safe_load(pathlib.Path('.github/workflows/foxclaw-security.yml').read_text()); print('workflow yaml ok')\"`
- M4 verification result:
  - fixture-based scan command succeeds and emits JSON/SARIF outputs.
  - `pytest` suite remains passing.
- Next: M5 (native snapshot/signing and drift-diff flow in CLI/state modules).
