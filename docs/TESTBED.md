# Testbed

FoxClaw uses a layered Firefox testbed strategy:

- deterministic fixture matrix (`tests/fixtures/testbed/`) for integration tests.
- local live profile smoke testing via `make certify-live`.
- optional containerized real Firefox smoke lane for scheduled coverage.

## Deterministic Fixture Matrix

Fixtures are generated by:

```bash
python scripts/generate_testbed_fixtures.py --write
```

Validate fixture integrity and manifest drift:

```bash
python scripts/generate_testbed_fixtures.py --check
git diff --quiet -- tests/fixtures/testbed
```

Run integration tests:

```bash
python scripts/generate_testbed_fixtures.py --write
pytest -q -m integration
```

`--write` is required before integration tests on fresh clones because Git does not preserve non-executable mode details (`0600` vs `0644`), and permission scenarios are part of the matrix.

## Scenario Profiles

- `profile_baseline`: valid prefs and SQLite, strict file modes, no policy override.
- `profile_weak_perms`: relaxed `key4.db` permissions to trigger filesystem HIGH findings.
- `profile_sqlite_error`: corrupted `places.sqlite` to trigger SQLite HIGH findings.
- `profile_policy_present`: policy override path includes deterministic enterprise hardening keys
  (`policies.DisableTelemetry`, `policies.DisableFirefoxStudies`, `policies.ExtensionSettings`,
  `policies.HTTPSOnlyMode`).
- `profile_active_lock`: `parent.lock` present for `--require-quiet-profile` validation.
- `profile_userjs_override`: `prefs.js` + `user.js` overlap to validate user.js precedence.
- `profile_third_party_xpi`: synthetic third-party XPI for extension add-on collection coverage.

Ruleset for integration scenarios:

- `tests/fixtures/testbed/rulesets/integration.yml`

Policy fixture path used by tests:

- `tests/fixtures/testbed/policies/disable_telemetry.json`

## Policy Path Override

The CLI supports deterministic policy-path injection:

```bash
foxclaw scan \
  --profile tests/fixtures/testbed/profile_policy_present \
  --ruleset tests/fixtures/testbed/rulesets/integration.yml \
  --policy-path tests/fixtures/testbed/policies/disable_telemetry.json \
  --json
```

When one or more `--policy-path` values are supplied, FoxClaw scans only those paths.

## Rust Parity Harness (WS-31 Bridge)

Run deterministic parity checks between Python and Rust CLI surfaces against the
fixture matrix:

```bash
make rust-parity-testbed
```

This target:

- checks `foxclaw-rs` workspace compile health.
- builds `foxclaw-rs-cli`.
- runs `scripts/rust_parity_runner.py` across testbed scenarios.
- fails closed on exit-code, JSON, or SARIF drift.

Quick smoke (engine-agnostic harness validation without Rust toolchain):

```bash
make rust-parity-smoke
```

## Migration Contract Fixtures (WS-32)

Canonical migration fixtures freeze deterministic scan JSON/SARIF outputs for the
testbed scenarios:

- `tests/fixtures/migration_contracts/manifest.json`
- `tests/fixtures/migration_contracts/cases/*/scan.json`
- `tests/fixtures/migration_contracts/cases/*/scan.sarif`

Validate fixture drift:

```bash
python scripts/generate_migration_contract_fixtures.py --check --python-cmd ".venv/bin/python -m foxclaw"
```

Regenerate fixtures intentionally:

```bash
python scripts/generate_migration_contract_fixtures.py --write --python-cmd ".venv/bin/python -m foxclaw"
```

Verify one engine against canonical fixtures:

```bash
python scripts/verify_migration_contract_engine.py --engine-cmd ".venv/bin/python -m foxclaw" --engine-label python
```

## Optional Containerized Firefox Smoke

Run locally (Docker required):

```bash
make test-firefox-container
```

If your user does not have direct Docker socket access:

```bash
make test-firefox-container DOCKER="sudo docker"
```

This builds `docker/testbed/Dockerfile`, launches Firefox headless to generate a real profile, runs a scan, and writes artifacts to `firefox-container-artifacts/`.

Equivalent compose workflow:

```bash
docker compose -f docker/testbed/docker-compose.yml run --rm firefox-esr-smoke
```
