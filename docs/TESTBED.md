# Testbed

FoxClaw uses a layered Firefox testbed strategy:

- deterministic fixture matrix (`tests/fixtures/testbed/`) for integration tests.
- local live profile smoke testing via `make certify-live`.
- optional containerized real Firefox smoke lane for scheduled coverage.

## Deterministic Fixture Matrix

Fixtures are generated by:

```bash
python scripts/generate_testbed_fixtures.py --write
```

Validate fixture integrity and manifest drift:

```bash
python scripts/generate_testbed_fixtures.py --check
git diff --quiet -- tests/fixtures/testbed
```

Run integration tests:

```bash
python scripts/generate_testbed_fixtures.py --write
pytest -q -m integration
```

`--write` is required before integration tests on fresh clones because Git does not preserve non-executable mode details (`0600` vs `0644`), and permission scenarios are part of the matrix.

## Scenario Profiles

- `profile_baseline`: valid prefs and SQLite, strict file modes, no policy override.
- `profile_weak_perms`: relaxed `key4.db` permissions to trigger filesystem HIGH findings.
- `profile_sqlite_error`: corrupted `places.sqlite` to trigger SQLite HIGH findings.
- `profile_policy_present`: policy override path includes deterministic enterprise hardening keys
  (`policies.DisableTelemetry`, `policies.DisableFirefoxStudies`, `policies.ExtensionSettings`,
  `policies.HTTPSOnlyMode`).
- `profile_active_lock`: `parent.lock` present for `--require-quiet-profile` validation.
- `profile_userjs_override`: `prefs.js` + `user.js` overlap to validate user.js precedence.
- `profile_third_party_xpi`: synthetic third-party XPI for extension add-on collection coverage.

Ruleset for integration scenarios:

- `tests/fixtures/testbed/rulesets/integration.yml`

Policy fixture path used by tests:

- `tests/fixtures/testbed/policies/disable_telemetry.json`

## Policy Path Override

The CLI supports deterministic policy-path injection:

```bash
foxclaw scan \
  --profile tests/fixtures/testbed/profile_policy_present \
  --ruleset tests/fixtures/testbed/rulesets/integration.yml \
  --policy-path tests/fixtures/testbed/policies/disable_telemetry.json \
  --json
```

When one or more `--policy-path` values are supplied, FoxClaw scans only those paths.

## Enterprise Windows Share Lane (WS-46)

For enterprise workflows where profile data is staged on Windows SMB shares,
FoxClaw now provides a deterministic stage-local-then-scan harness:

```bash
foxclaw scan \
  --profile /mnt/forensics/FirefoxProfiles/jdoe.default-release \
  --ruleset foxclaw/rulesets/strict.yml \
  --output /var/tmp/foxclaw-share-jdoe/foxclaw.json \
  --sarif-out /var/tmp/foxclaw-share-jdoe/foxclaw.sarif \
  --snapshot-out /var/tmp/foxclaw-share-jdoe/foxclaw.snapshot.json \
  --stage-manifest-out /var/tmp/foxclaw-share-jdoe/stage-manifest.json
```

Operational model:

- auto-stage source profile to local snapshot first (never scan live share in place),
- fail closed when active lock markers are present unless explicitly overridden,
- remove write bits from staged copy by default,
- emit JSON/SARIF/snapshot artifacts and stage manifest metadata.
- Windows-share profile generation should use a dedicated seed profile and emit
  deterministic sibling profiles under the active profile directory.

For orchestration wrappers that need explicit `--snapshot-id` or
`--treat-high-findings-as-success`, use `foxclaw acquire windows-share-scan`.
For multi-profile loops, use `foxclaw acquire windows-share-batch`.

Runbook:

- `docs/WINDOWS_SHARE_TESTING.md`
- quick smoke target: `make windows-share-smoke`
## Optional Containerized Firefox Smoke

Run locally (Docker required):

```bash
make test-firefox-container
```

If your user does not have direct Docker socket access:

```bash
make test-firefox-container DOCKER="sudo docker"
```

This builds `docker/testbed/Dockerfile`, launches Firefox headless to generate a real profile, runs a scan, and writes artifacts to `firefox-container-artifacts/`.

Equivalent compose workflow:

```bash
docker compose -f docker/testbed/docker-compose.yml run --rm firefox-esr-smoke
```
