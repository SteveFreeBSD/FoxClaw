# Code Review - 2026-02-20

This review covers full-repo quality gates, manual source audit, and runtime defect reproduction.

## Scope and Method

- Executed local release gate: `make certify`.
- Inspected runtime modules (`collect`, `rules`, `report`, `intel`, `cli`) for trust-boundary and determinism regressions.
- Reproduced edge-case failures with synthetic profiles/intel stores.
- Scanned for dead/empty placeholders (`pass`, `...`, `NotImplementedError`) in runtime/test code.

## Gate Result

- `make certify`: pass.
- Security/dead-code checks: pass (`bandit`, `vulture`, `detect-secrets`).
- Empty-function scan (`foxclaw/`, `tests/`): no empty function bodies found.

## Findings

### High

1. `compatibility.ini` parse failures could surface a traceback path during intel correlation.
   - Status: fixed.
   - Fix: `foxclaw/intel/correlation.py` now handles `configparser.Error` when reading profile version.
2. Corrupted/missing-schema `intel.db` could raise uncaught `sqlite3.OperationalError`.
   - Status: fixed.
   - Fix: `foxclaw/intel/correlation.py` now wraps sqlite query failures as operational `ValueError` with stable error text.

### Medium

1. `pref_equals` could treat `True` and `1` as equal due to Python bool/int coercion.
   - Status: fixed.
   - Fix: `foxclaw/rules/dsl.py` now enforces type-stable equality for preference comparisons.
2. `intel sync` accepted `http://` origins by default.
   - Status: fixed.
   - Fix: `intel sync` now blocks plaintext HTTP by default and requires `--allow-insecure-http`.
3. Local/CI quality-gate parity is documented as required but not yet fully enforced in CI jobs.
   - Status: fixed.
   - Fix: CI now includes dedicated quality-gates job for lint/type/security/dead-code/secret scanning.

### Low

1. Extension blocklist check still uses a mock static list.
   - Status: fixed.
   - Fix: extension blocklist state is now loaded from pinned intel snapshot data.

## Regression Tests Added

- `tests/test_intel_correlation.py`:
  - malformed `compatibility.ini` does not crash scan.
  - malformed intel sqlite schema reports operational error without traceback.
- `tests/test_rules_m3.py`:
  - bool/int mismatch in `pref_equals` fails deterministically.

## Next Artifact

- Ordered execution plan: `docs/WORKSLICES.md`.
- External ecosystem alignment snapshot: `docs/RESEARCH_2026-02-20.md`.

## Follow-On Slice Progress

- WS-06 complete: policy/ruleset coverage expanded to include `DisableFirefoxStudies`,
  `ExtensionSettings`, and `HTTPSOnlyMode` with updated balanced/strict versions and
  deterministic fixture/test coverage.
- WS-07 complete: NVD/CVE-list/KEV source adapters and indexing added with deterministic
  severity precedence (`mozilla > nvd > cve_list`), explicit conflict surfacing, and
  correlated finding provenance evidence.
- WS-08 complete: KEV/EPSS-aware deterministic risk prioritization added and exported via
  finding-level `risk_priority`/`risk_factors` in JSON and SARIF outputs.
