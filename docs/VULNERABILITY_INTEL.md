# Vulnerability Intelligence Strategy

This document defines how FoxClaw can add Mozilla CVE and extension vulnerability intelligence without weakening scan trust boundaries.

## Goals

- Correlate local Firefox posture with known Mozilla vulnerabilities.
- Evaluate installed extensions against known risk signals.
- Support both local-database mode and explicit live refresh mode.
- Preserve deterministic, offline-by-default scan behavior.

## Trust-Boundary Rules

- `scan` remains offline-by-default.
- Network access is only allowed in explicit intelligence update commands.
- Intelligence data must be snapshot-pinned during scan/evaluation.
- Reports must include intelligence snapshot metadata for replayability.

## Data Sources (Primary)

Mozilla vulnerability intelligence:

- Mozilla Foundation Security Advisories repository (MFSA + CVE references):
  - https://github.com/mozilla/foundation-security-advisories
- Mozilla Known Vulnerabilities index:
  - https://www.mozilla.org/security/known-vulnerabilities/
- Firefox product advisory pages (version and CVE mapping):
  - https://www.mozilla.org/security/known-vulnerabilities/firefox/

General CVE enrichment:

- NVD CVE API:
  - https://nvd.nist.gov/developers/vulnerabilities
- NVD Data Feeds:
  - https://nvd.nist.gov/vuln/data-feeds
- CVE Program list (CVE JSON v5):
  - https://github.com/CVEProject/cvelistV5

Exploitation prioritization:

- CISA KEV data:
  - https://github.com/cisagov/kev-data

Extension intelligence:

- Mozilla Add-ons API:
  - https://addons-server.readthedocs.io/en/latest/topics/api/addons.html
- AMO blocklist process and record source:
  - https://mozilla.github.io/addons-server/topics/blocklist.html
- Extension permission model (`manifest.json`):
  - https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions
- Extension ID conventions:
  - https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/browser_specific_settings

## Integration Model

### 1. Intelligence Sync Phase (Explicit Network Command)

Current command surface:

- `foxclaw intel sync`
  - ingests explicit `name=origin` source mappings (local files or URLs).
  - normalizes JSON payloads deterministically by default.
  - writes checksumed source artifacts and a snapshot manifest under local store.
  - records snapshot/source metadata in local SQLite index.
  - indexes normalized sources when payload schema is recognized.
    - current supported schema: `foxclaw.mozilla.firefox_advisories.v1`.

Expected output metadata:

- `intel_snapshot_id`
- `generated_at`
- per-source `sha256`
- per-source `schema_version`/`adapter`/`records_indexed`

### 2. Scan Correlation Phase (Offline)

- `foxclaw scan --intel-store-dir ... --intel-snapshot-id ...` reads only local intelligence snapshot.
- no runtime network lookups.
- profile Firefox version is read from `compatibility.ini` (`Compatibility.LastVersion`) and normalized.
- findings include reproducible intelligence metadata (source + snapshot id).

### 3. Optional Live Mode Wrapper

Possible wrapper for operator convenience:

- `foxclaw audit --live-intel`:
  - performs `intel sync`.
  - immediately runs scan pinned to that new snapshot.

This still preserves deterministic replay because scan references an explicit snapshot id.

## Local Intelligence Storage

Current implementation:

- SQLite-backed intelligence database for query speed and deterministic joins.
- Immutable snapshot manifest JSON per sync run.
- strict schema versioning.

Current tables:

- `intel_snapshots`
- `source_materials`
- `source_indexes`
- `mozilla_advisories`

Planned next tables:

- `cve_records`
- `cve_product_ranges`
- `extension_metadata`
- `extension_blocklist_state`

## Correlation Rules

Mozilla product CVE matching:

- normalize local Firefox version/build channel.
- map CVE records by affected version range and fixed version.
- enrich with CVSS and KEV status where available (next step).

Extension checks:

- inventory from local profile metadata and extension manifests.
- risk signals from:
  - requested permissions.
  - privileged host permissions.
  - blocklist status.
  - signing/install source posture.

## Determinism Controls

- pinned intelligence snapshot id in every correlated report.
- stable sorting for correlated findings.
- strict version parsing and deterministic tie-break ordering.
- no nondeterministic timestamps in evaluation outputs.

## Testing Plan

- fixture-backed unit tests for version-range matching.
- deterministic replay tests for same profile + same intelligence snapshot.
- integration tests for extension inventory and blocklist matching.
- schema migration tests for intelligence database upgrades.

## Risks and Mitigations

- Source inconsistency across feeds.
  - Mitigation: source precedence policy and conflict flags in metadata.
- Large feed size and sync time.
  - Mitigation: incremental sync and source-specific caches.
- False positives from coarse version mapping.
  - Mitigation: explicit confidence labels and rationale fields.
